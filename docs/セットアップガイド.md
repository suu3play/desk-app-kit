# DeskAppKit セットアップガイド

**最終更新**: 2025-01-18

## 目次

1. [システム要件](#システム要件)
2. [開発環境のセットアップ](#開発環境のセットアップ)
3. [プロジェクトのビルド](#プロジェクトのビルド)
4. [データベースのセットアップ](#データベースのセットアップ)
5. [初回起動と設定](#初回起動と設定)
6. [トラブルシューティング](#トラブルシューティング)

---

## システム要件

### 必須環境

- **OS**: Windows 10 / Windows 11 / Windows Server 2019以降
- **.NET Runtime**: .NET 8.0 Desktop Runtime（WPF対応）
- **データベース（Databaseモード使用時）**:
  - SQL Server 2019以降
  - SQL Server Express 2019以降
  - Azure SQL Database

### 開発環境（開発者向け）

- **IDE**: Visual Studio 2022（17.8以降）または Visual Studio Code + C# Dev Kit
- **.NET SDK**: .NET 8.0 SDK
- **ツール**:
  - Entity Framework Core Tools (`dotnet-ef`)
  - Git（ソース管理用）

---

## 開発環境のセットアップ

### 1. .NET 8.0 SDKのインストール

1. [.NET公式サイト](https://dotnet.microsoft.com/download/dotnet/8.0)からSDKをダウンロード
2. インストーラーを実行
3. インストール確認:

```bash
dotnet --version
# 出力例: 8.0.xxx
```

### 2. Entity Framework Core Toolsのインストール

```bash
dotnet tool install --global dotnet-ef --version 8.0.11
```

確認:

```bash
dotnet ef --version
# 出力例: Entity Framework Core .NET Command-line Tools 8.0.11
```

### 3. プロジェクトのクローン

```bash
git clone <リポジトリURL>
cd desk-app-kit
```

### 4. NuGetパッケージの復元

```bash
dotnet restore
```

---

## プロジェクトのビルド

### コマンドラインからのビルド

```bash
# ソリューション全体をビルド
dotnet build DeskAppKit.sln

# Releaseビルド
dotnet build DeskAppKit.sln -c Release
```

### Visual Studioからのビルド

1. `DeskAppKit.sln`をVisual Studioで開く
2. メニューから「ビルド」→「ソリューションのビルド」を選択
3. エラー0件、警告2件（Null参照可能性警告のみ）であることを確認

### テストの実行

```bash
# テストプロジェクトをビルドして実行
cd tests/App.IntegrationTests
dotnet test

# 出力例:
# 成功! - 失敗: 0、合格: 16、スキップ: 0、合計: 16
```

---

## データベースのセットアップ

DeskAppKitは2つのStorageModeをサポートしています：

### 1. Localモード（デフォルト）

- **概要**: JSONファイルベースのストレージ（SQLiteではなくJSON）
- **用途**: 個人使用、開発環境、オフライン環境
- **必要な設定**: なし（初回起動時に自動作成）

**データ保存先**:
- `%LOCALAPPDATA%\DeskAppKit\Data\settings_app.json` - アプリ設定
- `%LOCALAPPDATA%\DeskAppKit\Data\settings_user.json` - ユーザー設定
- `%LOCALAPPDATA%\DeskAppKit\Logs\` - ログファイル

### 2. Databaseモード

#### SQL Serverのインストール

1. **SQL Server Expressのダウンロード**
   - [SQL Server Express](https://www.microsoft.com/sql-server/sql-server-downloads)からダウンロード
   - Basic版またはAdvanced版を選択

2. **インストール**
   - インストーラーを実行
   - インスタンス名: デフォルト（SQLEXPRESS）推奨
   - 認証モード: Windows認証 または 混合モード（SQL Server認証）
   - TCP/IP接続を有効化

3. **SQL Server Management Studio（SSMS）のインストール**（推奨）
   - [SSMS公式サイト](https://docs.microsoft.com/sql/ssms/download-sql-server-management-studio-ssms)からダウンロード

#### データベースの作成

**方法1: 手動作成（SSMS使用）**

```sql
-- 新しいデータベースを作成
CREATE DATABASE DeskAppKitDb;
GO

-- データベースの確認
USE DeskAppKitDb;
GO
```

**方法2: Entity Framework Coreで自動作成**

1. 接続文字列の設定（後述の「bootstrap_db.json」参照）
2. マイグレーションの適用:

```bash
cd src/App.Infrastructure
dotnet ef database update
```

これにより、データベースとテーブルが自動的に作成されます。

#### 作成されるテーブル

| テーブル名 | 用途 |
|-----------|------|
| Users | ユーザー情報（認証用） |
| Settings | 設定情報（App/User別） |
| Logs | アプリケーションログ |
| SchemaVersions | スキーマバージョン管理 |
| ClientVersionStatuses | クライアントバージョン状態 |

---

## 初回起動と設定

### 1. Localモードでの起動（デフォルト）

1. アプリケーションを起動
2. 初回起動時、自動的にローカルストレージが初期化されます
3. ログイン画面が表示されます

**初回ユーザー登録**:
- Localモードでは、最初のユーザーを手動で登録する必要があります
- または、設定ファイルを手動編集してユーザーを追加します

### 2. Databaseモードでの起動

#### bootstrap_db.jsonの作成

Databaseモードを使用する場合、DB接続情報を暗号化して保存する`bootstrap_db.json`が必要です。

**ファイルパス**:
```
%LOCALAPPDATA%\DeskAppKit\Data\bootstrap_db.json
```

**作成方法**:

1. アプリケーションを起動（Localモードで起動）
2. メインメニューから「設定」を選択
3. StorageModeを「Database」に変更
4. DB接続情報を入力:
   - **サーバー名**: `localhost` または `.\SQLEXPRESS`
   - **データベース名**: `DeskAppKitDb`
   - **認証方式**:
     - Windows認証: 「Windows認証を使用」にチェック
     - SQL Server認証: ユーザー名とパスワードを入力
5. 「接続テスト」ボタンをクリックして接続確認
6. 「保存」ボタンをクリック
7. アプリケーションを再起動

**手動作成（上級者向け）**:

暗号化された形式で保存されるため、手動作成は推奨されません。アプリケーションのUI経由で作成してください。

#### マイグレーションの適用

```bash
cd src/App.Infrastructure
dotnet ef database update
```

#### 初回管理者ユーザーの作成

現在のバージョンでは、初回管理者ユーザーは手動で作成する必要があります。

**SQLスクリプト例**（SSMSで実行）:

```sql
USE DeskAppKitDb;
GO

-- パスワードは事前にBCryptでハッシュ化したものを使用
-- 例: "Admin123!" のハッシュ（WorkFactor=12）
DECLARE @PasswordHash NVARCHAR(MAX) = '$2a$12$...'; -- 実際のハッシュ値
DECLARE @Salt NVARCHAR(MAX) = '...'; -- 実際のSalt値

INSERT INTO Users (UserId, LoginId, DisplayName, PasswordHash, Salt, Role, AccountStatus, LockoutCount, CreatedAt)
VALUES (
    NEWID(),
    'admin',
    '管理者',
    @PasswordHash,
    @Salt,
    0, -- UserRole.Admin
    0, -- AccountStatus.Active
    0,
    GETUTCDATE()
);
GO
```

または、Localモードで初回ユーザーを作成後、Databaseモードに切り替えてユーザーデータを移行する方法もあります。

---

## トラブルシューティング

### ビルドエラー

**問題**: `dotnet build`時にエラー

**解決策**:
1. .NET 8.0 SDKがインストールされているか確認
   ```bash
   dotnet --version
   ```
2. NuGetパッケージを復元
   ```bash
   dotnet restore
   ```
3. キャッシュをクリア
   ```bash
   dotnet clean
   dotnet build
   ```

### データベース接続エラー

**問題**: "接続失敗" エラー

**解決策**:
1. SQL Serverサービスが起動しているか確認
   - サービス名: `SQL Server (SQLEXPRESS)`
2. TCP/IPが有効か確認
   - SQL Server Configuration Managerで確認
3. ファイアウォールの設定を確認
   - ポート1433（デフォルト）が開いているか
4. 接続文字列の確認
   - サーバー名が正しいか（`localhost` または `.\SQLEXPRESS`）
   - データベース名が正しいか
   - 認証情報が正しいか

### マイグレーションエラー

**問題**: `dotnet ef database update` 時にエラー

**解決策**:
1. dotnet-efツールがインストールされているか確認
   ```bash
   dotnet ef --version
   ```
2. Infrastructure層プロジェクトディレクトリで実行しているか確認
   ```bash
   cd src/App.Infrastructure
   ```
3. AppDbContextFactory.csの接続文字列を確認
   - デザインタイム用の一時的な接続文字列が正しいか

### 起動時エラー

**問題**: アプリケーションが起動しない

**解決策**:
1. .NET 8.0 Desktop Runtimeがインストールされているか確認
2. ログファイルを確認
   ```
   %LOCALAPPATA%\DeskAppKit\Logs\app_yyyyMMdd.log
   ```
3. 設定ファイルを削除して初期状態に戻す
   ```
   %LOCALAPPDATA%\DeskAppKit\Data\
   ```
   フォルダ内のファイルを削除

### StorageMode切り替え時の問題

**問題**: Databaseモードに切り替えたがLocalモードで起動する

**原因**: データベース接続失敗時、自動的にLocalモードにフォールバック

**解決策**:
1. ログファイルでエラー詳細を確認
2. DB接続情報が正しいか確認（設定画面で接続テスト）
3. SQL Serverが起動しているか確認

---

## サポート

### ログの確認

問題が発生した場合、まずログファイルを確認してください。

**ログ保存先**:
```
%LOCALAPPDATA%\DeskAppKit\Logs\app_yyyyMMdd.log
```

**ログレベル**:
- Debug: デバッグ情報
- Info: 通常の情報
- Warn: 警告
- Error: エラー

### 問い合わせ

- GitHub Issues: [リポジトリURL]/issues
- メール: support@example.com（要設定）

---

## 次のステップ

セットアップが完了したら、[運用マニュアル](./運用マニュアル.md)を参照して、アプリケーションの使用方法を確認してください。
