# DeskAppKit 運用マニュアル

**最終更新**: 2025-01-18

## 目次

1. [概要](#概要)
2. [アプリケーション起動](#アプリケーション起動)
3. [ログイン](#ログイン)
4. [メイン画面](#メイン画面)
5. [設定管理](#設定管理)
6. [診断とヘルスチェック](#診断とヘルスチェック)
7. [バックアップとリストア](#バックアップとリストア)
8. [トラブルシューティング](#トラブルシューティング)
9. [よくある質問](#よくある質問)

---

## 概要

DeskAppKitは、エンタープライズ環境向けのデスクトップアプリケーション開発フレームワークです。

### 主要機能

- **2つのStorageMode対応**:
  - **Localモード**: JSON形式でローカル保存（個人使用・開発環境向け）
  - **Databaseモード**: SQL Serverでデータ管理（企業環境・複数ユーザー向け）
- **認証とセキュリティ**:
  - BCryptによるパスワードハッシュ化（WorkFactor: 12）
  - AES-256による設定データ暗号化
  - アカウントロックアウト機能（5回失敗で30分ロック）
- **診断とヘルスチェック**:
  - CPU/メモリ使用率監視
  - ディスク空き容量チェック
  - データベース接続状態確認
- **ロギング**:
  - ファイルベースログ（日次ローテーション）
  - レベル別ログ出力（Debug/Info/Warn/Error）

---

## アプリケーション起動

### 初回起動

1. アプリケーションを起動します
2. 初回起動時、自動的にデータディレクトリが作成されます:
   ```
   %LOCALAPPDATA%\DeskAppKit\
   ├── Data\           # 設定ファイル・DB接続情報
   └── Logs\           # ログファイル
   ```
3. Localモードの場合、ログイン画面をスキップして直接メイン画面が表示されます
   - ローカルユーザーとして自動ログイン
   - すべての機能が利用可能（認証・ユーザー管理を除く）

4. Databaseモードの場合、ログイン画面が表示されます

### 通常起動

- デスクトップショートカットまたはスタートメニューから起動
- 前回のStorageModeで起動します

### 起動時の動作

1. **設定読み込み**: `settings_app.json`からStorageMode設定を読み込み
2. **Localモード時**:
   - ログイン画面をスキップ
   - ローカルユーザー（LoginId: `local`）として自動ログイン
   - 直接メイン画面を表示
3. **Databaseモード時**:
   - `bootstrap_db.json`から接続情報を読み込み
   - データベース接続テスト実行
   - 接続成功時: ログイン画面を表示
   - 接続失敗時: Localモードにフォールバック（ログに記録）

---

## ログイン

### Localモード

Localモードでは、ログイン画面は表示されません。

**自動ログイン情報**:
- ログインID: `local`
- 表示名: ローカルユーザー
- 権限: 管理者
- 備考: すべての機能が利用可能（認証・ユーザー管理を除く）

アプリケーション起動後、直接メイン画面が表示されます。

### Databaseモード

Databaseモードでは、認証機能が有効になります。

**ログイン手順**:
1. **ログインID**を入力
2. **パスワード**を入力
3. 「ログイン」ボタンをクリック

### ユーザー登録

Databaseモードでは、本格的な認証機能が利用できます。初期ユーザーは以下のいずれかの方法で作成してください：

1. **方法1**: SQLスクリプトで直接作成（[セットアップガイド](./セットアップガイド.md#初回管理者ユーザーの作成)参照）
2. **方法2**: ユーザー管理UI機能（将来実装予定）

### 認証エラー

#### ケース1: ログイン失敗

**メッセージ**: "ログインに失敗しました。ログインIDまたはパスワードが正しくありません。"

**原因**:
- ログインIDが存在しない
- パスワードが間違っている

**対処法**:
- 入力内容を確認
- Caps Lockキーの状態を確認

#### ケース2: アカウントロック

**メッセージ**: "アカウントがロックされています。解除時刻: yyyy/MM/dd HH:mm"

**原因**:
- 5回連続でログインに失敗

**対処法**:
- 表示された解除時刻（30分後）まで待機
- または、管理者にロック解除を依頼

**ロック解除方法（管理者向け）**:

**Databaseモード**:
```sql
-- アカウントロックを解除
UPDATE Users
SET AccountStatus = 0, LockoutCount = 0, LockoutUntil = NULL
WHERE LoginId = 'ユーザーID';
```

**Localモード**:
- 設定ファイルを手動編集（非推奨）

---

## メイン画面

### 画面構成

```
┌─────────────────────────────────────┐
│ DeskAppKit           [_][□][X]     │
├─────────────────────────────────────┤
│ [ホーム] [設定] [診断] [バージョン] [ログアウト] │
├─────────────────────────────────────┤
│                                     │
│        メインコンテンツエリア            │
│                                     │
│                                     │
│                                     │
└─────────────────────────────────────┘
```

### メニュー項目

| メニュー | 機能 |
|---------|------|
| ホーム | ホーム画面（開発予定） |
| 設定 | アプリケーション設定画面 |
| 診断 | システム診断とヘルスチェック |
| バージョン | アプリケーション情報 |
| ログアウト | ログアウトしてログイン画面へ戻る |

---

## 設定管理

### 設定画面の開き方

1. メインメニューから「設定」をクリック
2. 設定ダイアログが表示されます

### StorageMode設定

#### Localモード

**用途**:
- 個人使用
- 開発・テスト環境
- オフライン環境

**設定方法**:
1. StorageModeドロップダウンから「Local」を選択
2. 「保存」ボタンをクリック
3. アプリケーションを再起動

**データ保存先**:
```
%LOCALAPPDATA%\DeskAppKit\Data\
├── settings_app.json      # アプリ設定（暗号化）
└── settings_user.json     # ユーザー設定（暗号化）
```

#### Databaseモード

**用途**:
- 複数ユーザー環境
- エンタープライズ環境
- 集中管理が必要な環境

**設定方法**:

1. StorageModeドロップダウンから「Database」を選択
2. データベース接続情報を入力:

   **Windows認証を使用する場合**:
   - サーバー名: `localhost` または `.\SQLEXPRESS`
   - データベース名: `DeskAppKitDb`
   - 「Windows認証を使用」にチェック

   **SQL Server認証を使用する場合**:
   - サーバー名: `localhost` または `.\SQLEXPRESS`
   - データベース名: `DeskAppKitDb`
   - 「Windows認証を使用」のチェックを外す
   - ユーザー名: `sa` など
   - パスワード: SQL Serverのパスワード

3. 「接続テスト」ボタンをクリックして接続確認
   - **成功時**: "接続成功" と表示
   - **失敗時**: "接続失敗" または具体的なエラーメッセージ

4. 「保存」ボタンをクリック
   - `bootstrap_db.json`に接続情報が暗号化保存されます

5. アプリケーションを再起動

### 設定変更時の注意事項

- **StorageMode変更後は必ず再起動が必要です**
- LocalモードとDatabaseモードでは、データは共有されません
- Databaseモードで接続失敗時は自動的にLocalモードにフォールバックします

---

## 診断とヘルスチェック

### 診断画面の開き方

1. メインメニューから「診断」をクリック
2. 診断ダイアログが表示されます

### ヘルスチェック項目

#### 1. CPU使用率

**項目**: プロセスのCPU使用率
- **正常範囲**: 0% - 80%
- **警告レベル**: 80%以上
- **確認方法**: タスクマネージャーと比較

#### 2. メモリ使用量

**項目**: プロセスのメモリ使用量
- **正常範囲**: 取得成功
- **確認方法**: タスクマネージャーと比較

#### 3. ディスク空き容量

**項目**: システムドライブ（C:\）の空き容量
- **正常範囲**: 10GB以上
- **警告レベル**: 10GB未満
- **推奨対応**: 不要ファイルの削除、ディスククリーンアップ

#### 4. データベース接続（Databaseモードのみ）

**項目**: SQL Server接続状態
- **正常**: 接続成功
- **異常**: 接続失敗
- **確認内容**:
  - SQL Serverサービス起動状態
  - ネットワーク接続
  - 認証情報の正確性

### ヘルスチェック結果の解釈

```
✅ CPU使用率: 5.2%              → 正常
✅ メモリ使用量: 120 MB          → 正常
✅ ディスク空き容量: 50 GB       → 正常
✅ データベース接続: 接続成功      → 正常（Databaseモード時）
```

### トラブル時の対処

#### CPU使用率が高い（80%以上）

**原因**:
- バックグラウンド処理の負荷
- 他のアプリケーションの影響

**対処法**:
1. タスクマネージャーで他のプロセスを確認
2. 不要なプロセスを終了
3. アプリケーションを再起動

#### ディスク空き容量不足（10GB未満）

**原因**:
- ログファイルの蓄積
- 一時ファイルの蓄積

**対処法**:
1. 古いログファイルを削除
   ```
   %LOCALAPPDATA%\DeskAppKit\Logs\
   ```
2. Windowsディスククリーンアップを実行
3. 不要なファイルを削除

#### データベース接続失敗

**原因**:
- SQL Serverサービス停止
- ネットワーク接続問題
- 認証情報の誤り

**対処法**:
1. SQL Serverサービスを確認・起動
   ```
   サービス > SQL Server (SQLEXPRESS)
   ```
2. 接続情報を再確認（設定画面で接続テスト）
3. ファイアウォール設定を確認

---

## バックアップとリストア

### Localモードのバックアップ

#### バックアップ対象

```
%LOCALAPPDATA%\DeskAppKit\Data\
├── settings_app.json       # アプリ設定
├── settings_user.json      # ユーザー設定
└── bootstrap_db.json       # DB接続情報（Databaseモード使用時）
```

#### バックアップ手順

1. アプリケーションを終了
2. 上記フォルダを別の場所にコピー
   ```
   例: D:\Backup\DeskAppKit\Data_20250118\
   ```
3. 定期的にバックアップを取得（推奨: 週次）

#### リストア手順

1. アプリケーションを終了
2. バックアップファイルを元の場所に上書きコピー
3. アプリケーションを起動

### Databaseモードのバックアップ

#### データベースバックアップ

**方法1: SQL Server Management Studio（SSMS）**

1. SSMSでデータベースに接続
2. データベース名（`DeskAppKitDb`）を右クリック
3. 「タスク」→「バックアップ」を選択
4. バックアップの種類: 完全
5. 保存先を指定して「OK」

**方法2: T-SQLコマンド**

```sql
BACKUP DATABASE DeskAppKitDb
TO DISK = 'D:\Backup\DeskAppKitDb_20250118.bak'
WITH FORMAT, COMPRESSION;
```

#### データベースリストア

**方法1: SSMS**

1. SSMSでサーバーに接続
2. 「データベース」を右クリック
3. 「データベースの復元」を選択
4. バックアップファイルを指定
5. 「OK」をクリック

**方法2: T-SQLコマンド**

```sql
RESTORE DATABASE DeskAppKitDb
FROM DISK = 'D:\Backup\DeskAppKitDb_20250118.bak'
WITH REPLACE;
```

---

## トラブルシューティング

### アプリケーションが起動しない

**症状**: ダブルクリックしても何も起きない

**原因と対処法**:

1. **.NET Runtimeがインストールされていない**
   - [.NET公式サイト](https://dotnet.microsoft.com/download/dotnet/8.0)から.NET 8.0 Desktop Runtimeをインストール

2. **設定ファイルが破損**
   - 設定ファイルを削除して初期状態に戻す:
     ```
     %LOCALAPPDATA%\DeskAppKit\Data\
     ```

3. **ログでエラーを確認**
   ```
   %LOCALAPPDATA%\DeskAppKit\Logs\app_yyyyMMdd.log
   ```

### データベースに接続できない

**症状**: "接続失敗" エラー

**原因と対処法**:

1. **SQL Serverサービスが起動していない**
   - サービスアプリを開く
   - 「SQL Server (SQLEXPRESS)」を起動

2. **ファイアウォールがブロックしている**
   - Windowsファイアウォールで例外を追加
   - ポート1433を許可

3. **接続文字列が間違っている**
   - 設定画面で接続情報を再確認
   - 接続テストを実行

### ログファイルが大きくなりすぎた

**症状**: ログフォルダが数GBに膨れ上がっている

**対処法**:

1. **古いログファイルを削除**
   ```
   %LOCALAPPDATA%\DeskAppKit\Logs\
   ```
   - 30日以前のログファイルを削除

2. **ログローテーション設定**（将来実装予定）
   - 自動削除機能の追加
   - ログレベルの調整

---

## よくある質問

### Q1: LocalモードとDatabaseモードの違いは？

**A**:
- **Localモード**: JSONファイルでローカル保存。個人使用・開発環境向け。シンプルで設定不要。
- **Databaseモード**: SQL Serverでデータ管理。複数ユーザー・エンタープライズ環境向け。集中管理可能。

### Q2: StorageModeは後から変更できる？

**A**: はい、設定画面からいつでも変更可能です。ただし、変更後はアプリケーションの再起動が必要で、モード間でデータは引き継がれません。

### Q3: パスワードを忘れた場合は？

**A**:
- **Databaseモード**: 管理者にSQL Serverで直接パスワードリセットを依頼
- **Localモード**: 設定ファイルを削除して再作成（ユーザーデータも消去されます）

### Q4: 複数PCで同じ設定を使いたい

**A**: Databaseモードを使用してください。複数PCから同じSQL Serverに接続することで、設定とユーザー情報を共有できます。

### Q5: ログファイルはどこに保存される？

**A**:
```
%LOCALAPPDATA%\DeskAppKit\Logs\app_yyyyMMdd.log
```
日次でローテーションされます（例: `app_20250118.log`）

### Q6: アカウントロック解除までの時間は？

**A**: デフォルトで30分です。5回連続ログイン失敗時にロックされます。

### Q7: データベースマイグレーションはどうやって適用する？

**A**:
```bash
cd src/App.Infrastructure
dotnet ef database update
```
初回セットアップ時に実行します。

### Q8: 暗号化キーを変更したい

**A**: 現在のバージョンでは、暗号化キーの変更機能は実装されていません。キーはハードコードされています。カスタマイズが必要な場合は、ソースコードの`App.xaml.cs`内のキーを変更して再ビルドしてください。

### Q9: バックアップは自動で取られる？

**A**: いいえ。現バージョンでは手動バックアップが必要です。定期的にデータフォルダまたはデータベースをバックアップしてください。

### Q10: ログレベルは変更できる？

**A**: 現在のバージョンでは固定されています。将来的には設定画面から変更可能にする予定です。

---

## サポート

### ログの確認方法

問題が発生した場合、ログファイルを確認してください。

**ログファイルパス**:
```
%LOCALAPPDATA%\DeskAppKit\Logs\app_yyyyMMdd.log
```

**ログフォーマット例**:
```
2025-01-18 10:30:45.123 [INFO] App - アプリケーション起動
2025-01-18 10:30:46.456 [INFO] SettingsService - StorageMode: Local
2025-01-18 10:30:50.789 [ERROR] AuthenticationService - ログイン失敗: ユーザーが存在しません
```

### 問い合わせ先

- **GitHub Issues**: [リポジトリURL]/issues
- **メール**: support@example.com（要設定）
- **ドキュメント**: [セットアップガイド](./セットアップガイド.md)

---

## 更新履歴

| バージョン | リリース日 | 変更内容 |
|-----------|----------|---------|
| 1.0.0 | 2025-01-18 | 初版リリース |

---

**次のステップ**: 開発者向けの詳細は[実装状況](./実装状況.md)を参照してください。
