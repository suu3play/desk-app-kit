# 📘 **アプリケーション共通基盤 仕様書**

本ドキュメントは、小規模〜中規模の C#（WPF/WinForms） デスクトップアプリケーションを
再利用可能な基盤として効率的に開発するための**標準仕様書**である。

---

# 0. 全体概要

本基盤の目的は以下：

-   ログ・設定管理を標準化し、案件ごとの再実装を無くす
-   DB 接続・ログイン・バージョン管理・診断などを横断的に共通化
-   自動アップデート・ダウングレードを安全に運用できる仕組みを提供
-   Local / Database の両モードに対応し、環境による柔軟運用を実現
-   フェイルセーフ（安全に Local へフォールバック）を確保
-   端末管理・バージョン管理が中央集約される構造を提供

---

# 1. プロジェクト構成（C# 例）

```
AppRoot/
  src/
    App.Client/           # UI層（WPF）
      Views/
      ViewModels/
      Components/
      Converters/
      Services/
      Resources/
      Startup/
    App.Core/             # ドメイン・インターフェイス層
      Models/
      Enums/
      Interfaces/
      Services/
      Exceptions/
    App.Infrastructure/   # 実装層
      Persistence/
        DbContexts/
        Repositories/
        Migrations/
      Logging/
        FileLogger/
        DbLogger/
      Settings/
        Local/
        Database/
        Encryption/
      Security/
        PasswordHash/
        AccountLock/
      Update/
        UpdateChecker/
        PackageDownloader/
        InstallerRunner/
      Diagnostics/
        HealthCheck/
        EnvironmentInfo/
    App.AdminTool/        # 任意：ダウングレード等管理ツール
  docs/
    仕様書.md
  tools/
    migration/
```

---

# 2. StorageMode（Local / Database）管理仕様

## 2.1 概要

アプリ全体の「設定・ログの保存方式」を以下の 2 種類で切り替える：

-   **Local**

    -   設定：settings_app.json / settings_user.json
    -   ログ：ローカルログ（JSON Lines）

-   **Database**

    -   設定：Settings テーブル
    -   ログ：Logs テーブル

### ※ SchemaVersion / ClientVersionStatus は DB 必須（StorageMode に依存しない）

---

## 2.2 設定キー（ローカル専用）

settings_app.json に保存：

```
System.StorageMode : "Local" / "Database"
```

---

## 2.3 フェイルセーフ：Local への自動フォールバック

StorageMode = "Database" が指定されていても、以下に該当すると
**強制的に Local として動作**する：

-   bootstrap_db.json が存在しない
-   bootstrap_db.json の復号に失敗
-   接続情報が不足
-   DB 接続テストが連続失敗

### フォールバック時の挙動

-   設定：settings_app.json / settings_user.json を使用
-   ログ：ローカル出力
-   SchemaVersion / ClientVersionStatus：参照できず（診断画面に表示）
-   バージョン情報は settings_app.json に保持（後述）

---

## 2.4 Local フォールバック時のバージョン保持

settings_app.json に下記を記録し続ける：

```
System.LastKnownAppVersion
System.LastKnownSchemaVersion
```

用途：

-   Local モード時もバージョン情報表示可能
-   再度 Database モードに戻った際に差分更新ができる

---

# 3. ログ管理仕様

## 3.1 出力方式

StorageMode に応じて自動切替：

| StorageMode | 出力先                 |
| ----------- | ---------------------- |
| Local       | ローカル（JSON Lines） |
| Database    | Logs テーブル          |

## 3.2 ログ項目

-   Timestamp
-   Level
-   Logger
-   Message
-   Exception
-   UserId
-   MachineName
-   AppVersion
-   ContextJson

## 3.3 ログレベル

`DEBUG / INFO / WARN / ERROR`

---

# 4. 設定管理仕様（Settings）

## 4.1 Local 設定ファイル

-   settings_app.json（アプリ設定）
-   settings_user.json（ユーザ別設定）
-   すべての値は暗号化済みで保存

## 4.2 Database 設定（Settings テーブル）

Settings テーブルにて管理するが、
**System カテゴリはローカル専用**で DB には保存しない。

---

# 5. DB 接続仕様

## 5.1 bootstrap_db.json（ローカルに保持）

-   暗号化された DB 接続情報
-   StorageMode が Database の場合、必須
-   設定画面で接続テスト → 保存の流れ

## 5.2 挙動パラメータ（Settings 管理）

-   Db.CommandTimeoutSeconds
-   Db.RetryCount
-   Db.RetryDelayMilliseconds
-   Db.ProviderName

## 5.3 再試行付き接続ロジック

タイムアウト時、自動的に指定回数リトライを行う。

---

# 6. ログイン／ユーザ管理仕様

-   Users テーブルにて管理
-   パスワードはハッシュ（Salt 付き）
-   アカウント状態：

    -   Active / Locked / Suspended / Retired

-   ロックアウト回数と解除時刻を保持
-   権限ロール：Admin / User / Viewer

---

# 7. UI 共通基盤

-   統一ダイアログ
-   入力バリデーション
-   標準画面テンプレート

    -   ログイン
    -   設定
    -   診断
    -   バージョン情報
    -   メインメニュー

---

# 8. グローバル例外処理

-   UI スレッド例外：ログ記録 + ダイアログ表示
-   バックグラウンド例外：ログ記録
-   エラーレポート ZIP 生成（ログ＋環境情報）

---

# 9. 診断（ヘルスチェック）

-   DB 接続テスト
-   アップデートサーバ疎通
-   OS / .NET ランタイム
-   ログファイル表示
-   SchemaVersion（DB 不可時は Local 表示）

---

# 10. 自動アップデート仕様

## 10.1 条件

以下を満たす最新バージョンが「配布上限バージョン」となる：

-   DevApproved = 1
-   UserApproved = 1
-   IsAvailableForUpgrade = 1

## 10.2 処理フロー

1. チェック（起動時 or 定期）
2. 最新バージョン取得
3. 差分判定
4. ダウンロード
5. ハッシュ検証
6. アプリ終了 → インストーラ実行
7. DB マイグレーション（Up）
8. ClientVersionStatus 更新
9. ログ記録

---

# 11. ダウングレード仕様

## 11.1 実行条件

-   Admin 権限のみ
-   SchemaVersion の

    -   IsAvailableForDowngrade = 1
    -   DevApproved = 1

## 11.2 フロー

1. バージョン選択
2. 警告
3. 旧バージョンインストール
4. Down マイグレーション実行
5. SchemaVersion.IsCurrent 更新
6. ClientVersionStatus 更新
7. AutoUpdateEnabled = 0 にする
8. ログ記録

---

# 12. データベース仕様（テーブル定義）

## 12.1 Users

| カラム名              | 説明                                  |
| --------------------- | ------------------------------------- |
| UserId                | ユーザ識別子                          |
| LoginId               | ログイン ID（ユニーク）               |
| DisplayName           | 表示名                                |
| PasswordHash / Salt   | パスワードハッシュ                    |
| Role                  | Admin / User / Viewer                 |
| AccountStatus         | Active / Locked / Suspended / Retired |
| LockoutCount          | ロック回数                            |
| LockoutUntil          | ロック解除予定                        |
| LastLoginAt           | 最終ログイン                          |
| CreatedAt / UpdatedAt | 作成・更新                            |

---

## 12.2 Settings

| カラム名        | 説明         |
| --------------- | ------------ |
| SettingId       | 識別子       |
| ScopeType       | App / User   |
| UserId          | User 設定時  |
| Category        | 設定カテゴリ |
| Key             | 設定名       |
| ValueEncrypted  | 暗号化値     |
| DataType        | 型情報       |
| Description     | 説明         |
| UpdatedByUserId | 最終更新者   |
| UpdatedAt       | 更新時刻     |

---

## 12.3 Logs

| カラム名    | 説明                  |
| ----------- | --------------------- |
| LogId       | ログ識別子            |
| Timestamp   | 発生時刻              |
| Level       | DEBUG/INFO/WARN/ERROR |
| Logger      | 出力元                |
| Message     | 内容                  |
| Exception   | 例外                  |
| UserId      | 実行ユーザ            |
| MachineName | 端末名                |
| AppVersion  | アプリバージョン      |
| ContextJson | 追加 JSON             |

---

## 12.4 SchemaVersion

| カラム名                | 説明            |
| ----------------------- | --------------- |
| SchemaVersionId         | ID              |
| Version                 | バージョン番号  |
| IsCurrent               | 現行スキーマ    |
| IsAvailableForUpgrade   | 自動配布可      |
| IsAvailableForDowngrade | ダウングレ可    |
| DevApproved / At / By   | 開発者承認      |
| UserApproved / At / By  | ユーザ承認      |
| MigrationScriptUpPath   | Up スクリプト   |
| MigrationScriptDownPath | Down スクリプト |
| ReleaseDate             | リリース日      |
| Notes                   | メモ            |
| UpdatedAt               | 更新            |

---

## 12.5 ClientVersionStatus

| カラム名               | 説明               |
| ---------------------- | ------------------ |
| ClientVersionStatusId  | ID                 |
| MachineName            | 端末名             |
| UserId                 | 利用ユーザ         |
| CurrentAppVersion      | 現在のアプリ ver   |
| CurrentSchemaVersion   | 現在のスキーマ ver |
| AutoUpdateEnabled      | 自動 ON/OFF        |
| LastUpdateCheckAt      | チェック時刻       |
| LastUpdateResult       | 成功/失敗/NoUpdate |
| LastUpdateErrorMessage | エラー内容         |
| IsActive               | 端末状態           |

---

# 13. Settings キー一覧（候補）

## System（ローカル専用）

-   System.StorageMode
-   System.LastKnownAppVersion
-   System.LastKnownSchemaVersion

## Db

-   Db.ProviderName
-   Db.CommandTimeoutSeconds
-   Db.RetryCount
-   Db.RetryDelayMilliseconds

## Logging

-   Logging.Level
-   Logging.LocalLogDirectory
-   Logging.MaxFileSizeMB
-   Logging.RetentionDays

## Update

-   Update.ServerUrl
-   Update.CheckOnStartup
-   Update.CheckIntervalDays
-   Update.AllowAutoInstall

## Ui（User スコープ）

-   Ui.Theme
-   Ui.Language
-   Ui.WindowSize

## Security

-   Security.PasswordRetryLimit
-   Security.LockoutMinutes

## Diagnostics

-   Diagnostics.EnableHealthCheckLogging

---

# 14. ローカルファイル構成

-   settings_app.json
-   settings_user.json
-   bootstrap_db.json
-   logs/app_YYYYMMDD.log

---

# 15. 権限仕様

| ロール | 権限                                           |
| ------ | ---------------------------------------------- |
| Admin  | 設定・ユーザ管理・アップデート・ダウングレード |
| User   | 通常利用・診断                                 |
| Viewer | 参照のみ                                       |
